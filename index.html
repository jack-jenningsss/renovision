<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Roofing & Joinery - Demo Site</title>
    
    <style>
        body { font-family: Helvetica, Arial, sans-serif; margin: 0; padding: 0; color: #333; background-color: #f4f4f9; }
        header { background-color: #333; color: white; padding: 20px; text-align: center; }
        .container { max-width: 960px; margin: 0 auto; padding: 40px 20px; background: white; min-height: 800px; }
        .hero { background-color: #e6f0ff; padding: 60px 20px; text-align: center; border-radius: 8px; margin-bottom: 30px; border: 1px solid #0066cc; }
        h1 { margin: 0; }
        h2 { color: #0066cc; }
        p { line-height: 1.6; }
        .placeholder-content { height: 600px; background: #eee; margin-top: 20px; display: flex; justify-content: center; align-items: center; color: #999; font-style: italic; }
    </style>

    <style>
      /* 1. THE WIDGET STYLING */
      :root {
        --primary-color: #0066cc; /* Change this to match contractor brand */
        --text-white: #ffffff;
        --bg-chat: #f4f4f4;
      }
    
      /* The Floating Button */
      #trade-widget-launcher {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--primary-color);
        color: var(--text-white);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        cursor: pointer;
        z-index: 9999;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }
    
      #trade-widget-launcher:hover { transform: scale(1.05); }
    
      /* The Chat Window */
      #trade-chat-window {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 350px;
        height: 500px;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        display: none; /* Hidden by default */
        flex-direction: column;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        overflow: hidden;
      }
    
      /* Header */
      .chat-header {
        background-color: var(--primary-color);
        color: white;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    
      /* Messages Area */
      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--bg-chat);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
    
      .message {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
      }
    
      .bot-msg {
        background-color: white;
        color: #333;
        border-bottom-left-radius: 2px;
        align-self: flex-start;
        border: 1px solid #e0e0e0;
      }
    
      .user-msg {
        background-color: var(--primary-color);
        color: white;
        border-bottom-right-radius: 2px;
        align-self: flex-end;
      }
    
      /* Input Area */
      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
      }
    
      #chat-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 20px;
        outline: none;
      }
    
      #send-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        font-weight: bold;
        cursor: pointer;
      }
    
      /* Action Buttons (For Choices) */
      .action-btn-container {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        margin-top: 5px;
      }
      .action-btn {
        background-color: white;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .action-btn:hover {
        background-color: var(--primary-color);
        color: white;
      }
    
      /* Image Preview Styling */
      .img-preview {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
      }
      
      /* Loading Spinner */
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    </style>
</head>
<body>

    <header>
        <h1>Elite Roofing & Joinery Co.</h1>
    </header>

    <div class="container">
        <div class="hero">
            <h2>Quality Renovations for Your Home</h2>
            <p>We specialize in premium roofing, bespoke joinery, and complete fitting services. Look around our site to see our work.</p>
            <button style="background:#0066cc; color:white; padding: 15px 30px; border:none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px;">View Portfolio</button>
        </div>

        <h3>Why Choose Us?</h3>
        <p>We deliver high-quality craftsmanship with over 20 years of experience in the trade. From slate roofs to custom kitchen fittings, we ensure every detail is perfect.</p>
        
        <p><i>(Scroll down the page... notice the chat bubble stays in the bottom right corner.)</i></p>

        <div class="placeholder-content">
            Lots more website content goes here...
        </div>
    </div>

    <button id="trade-widget-launcher">üí¨</button>

    <div id="trade-chat-window">
      <div class="chat-header">
        <span>TradeVision Assistant</span>
        <span style="cursor:pointer;" onclick="toggleChat()">‚úï</span>
      </div>
      <div class="chat-messages" id="chat-messages">
        </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button id="send-btn">Send</button>
      </div>
      <input type="file" id="image-upload" accept="image/*" style="display: none;">
    </div>


    <script>
      // 2. THE JAVASCRIPT LOGIC
      
      const launcher = document.getElementById('trade-widget-launcher');
      const windowEl = document.getElementById('trade-chat-window');
      const messagesEl = document.getElementById('chat-messages');
      const inputEl = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const fileInput = document.getElementById('image-upload');
    
      // State Management
      let chatState = 'initial'; // initial, awaiting_photo, awaiting_prompt, awaiting_email, processing
      let userData = { photo: null, prompt: null, email: null, generatedImage: null };
    
      // Toggle Chat
      function toggleChat() {
        const isVisible = windowEl.style.display === 'flex';
        windowEl.style.display = isVisible ? 'none' : 'flex';
        if (!isVisible && messagesEl.children.length === 0) {
          initChat();
        }
      }
    
      launcher.addEventListener('click', toggleChat);
    
      // Helper: Add Message
      function addMessage(text, sender, isImage = false) {
        const div = document.createElement('div');
        div.classList.add('message', sender === 'bot' ? 'bot-msg' : 'user-msg');
        
        if (isImage) {
            const img = document.createElement('img');
            img.src = text;
            img.classList.add('img-preview');
            div.appendChild(img);
            return div; // Return div so we can manipulate the image later
        } else {
            div.innerHTML = text; // Allow HTML for buttons
        }
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return div;
      }
    
      // Helper: Initial Greeting
      function initChat() {
        addMessage("Hi! I'm the AI assistant. How can I help you today?", 'bot');
        setTimeout(() => {
          const actions = `
            <div class="action-btn-container">
              <button class="action-btn" onclick="startRenovation()">Visualise Renovation üè†</button>
              <button class="action-btn" onclick="handleSupport()">Ask a Question ‚ùì</button>
            </div>
          `;
          addMessage(actions, 'bot');
        }, 500);
      }
    
      // --- FLOW 1: SUPPORT AGENT ---
      function handleSupport() {
        chatState = 'support';
        addMessage("Sure, ask me anything about our roofing, joinery, or fitting services.", 'bot');
      }
    
      // --- FLOW 2: RENOVATION VISUALISER ---
      function startRenovation() {
        chatState = 'awaiting_photo';
        addMessage("Let's visualize your upgrade! First, please <b>upload a clear photo</b> of the area (Roof, Kitchen, etc).", 'bot');
        
        // Trigger file upload automatically or show button
        addMessage(`<button class="action-btn" onclick="document.getElementById('image-upload').click()">üìÅ Click to Upload Photo</button>`, 'bot');
      }
    
      // Handle File Selection
      fileInput.addEventListener('change', (e) => {
        if (chatState !== 'awaiting_photo') return;
        const file = e.target.files[0];
        if (file) {
          // Show local preview immediately
          const reader = new FileReader();
          reader.onload = function(e) {
            userData.photo = file; // Store the FILE object, not base64, for upload
            addMessage(e.target.result, 'user', true); // Show preview
            chatState = 'awaiting_prompt';
            setTimeout(() => addMessage("Great photo! What would you like to change? (e.g., 'Change roof to slate', 'Make cabinets blue')", 'bot'), 600);
          };
          reader.readAsDataURL(file);
        }
      });
    
      // Handle Text Input
      function handleInput() {
        const text = inputEl.value.trim();
        if (!text) return;
        
        addMessage(text, 'user');
        inputEl.value = '';
    
        // Logic Switcher
        if (chatState === 'support') {
           setTimeout(() => addMessage("That's a great question. Usually, we charge per square meter. Would you like a formal quote?", 'bot'), 1000);
        } 
        else if (chatState === 'awaiting_prompt') {
          userData.prompt = text;
          processAI_preview();
        } 
        else if (chatState === 'awaiting_email') {
          if(validateEmail(text)) {
            userData.email = text;
            revealFullImageAndConfirm();
          } else {
            setTimeout(() => addMessage("That doesn't look like a valid email. Please try again.", 'bot'), 500);
          }
        }
      }
    
      sendBtn.addEventListener('click', handleInput);
      inputEl.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleInput(); });
    
      function validateEmail(email) {
        return /\S+@\S+\.\S+/.test(email);
      }
    
      // --- BACKEND CONNECTION ---
      
      let lastPreviewEl = null; 
    
      async function processAI_preview() {
        chatState = 'processing_preview';
    
        const loaderHtml = `<div style="display:flex;flex-direction:column;align-items:center;gap:6px;"><div class="spinner"></div><div><b>Creating preview...</b></div><div style="font-size:12px;color:#666;">This may take ~10‚Äì20 seconds.</div></div>`;
        const loaderEl = addMessage(loaderHtml, 'bot');
    
        try {
          const formData = new FormData();
          formData.append('image', userData.photo); // Send the actual file
          formData.append('prompt', userData.prompt);
    
          // Hit the Python backend at the relative path
          // NOTE: This assumes this HTML file is being served by your Flask app. 
          // If you open this file directly from your desktop, change '/api/preview' to 'http://localhost:5000/api/preview' or your Render URL.
          const response = await fetch('/api/preview', { 
            method: 'POST',
            body: formData
          });
    
          const data = await response.json();
          try { loaderEl.remove(); } catch(e) {}
    
          if (data.imageUrl) {
            addMessage("<b>Preview:</b>", 'bot');
            
            // Show blurred preview
            userData.generatedImage = data.imageUrl;
            lastPreviewEl = addMessage(userData.generatedImage, 'bot', true);
            
            // Apply blur effect
            const img = lastPreviewEl.querySelector('img');
            if (img) {
                img.style.filter = 'blur(5px)';
                img.style.transition = 'filter 0.5s ease';
            }
    
            // Ask for email
            setTimeout(() => {
                addMessage("To see the HD result and get your reference number, please enter your <b>email address</b>.", 'bot');
                chatState = 'awaiting_email';
            }, 600);
    
          } else {
            addMessage("‚ö†Ô∏è Error: " + (data.error || "Could not generate image."), 'bot');
            chatState = 'initial';
          }
    
        } catch (error) {
          console.error(error);
          try { loaderEl.remove(); } catch(e) {}
          addMessage("Connection error. Is the server running?", 'bot');
          chatState = 'initial';
        }
      }
    
      // --- EMAIL SENDING VIA MAKE.COM WEBHOOK ---
      // PASTE YOUR MAKE.COM WEBHOOK URL HERE:
      const MAKE_WEBHOOK_URL = "https://hook.us1.make.com/YOUR_LONG_CODE_HERE"; 

      async function revealFullImageAndConfirm() {
        // 1. Generate a Reference Number locally
        const refNum = 'RV-' + Math.random().toString(36).substring(2,8).toUpperCase();
        const contactNum = "01234 567890"; // Your company number

        // 2. Unblur the image for the user immediately
        if (lastPreviewEl) {
            const img = lastPreviewEl.querySelector('img');
            if (img) img.style.filter = 'none';
        }

        addMessage("Sending details...", 'bot');

        try {
            // 3. Send data to Make.com
            await fetch(MAKE_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userData.email,
                    image_url: userData.generatedImage,
                    prompt: userData.prompt,
                    reference: refNum,
                    contact: contactNum
                })
            });

            // 4. Show success message (We assume it worked if the fetch sent)
            addMessage(`‚úÖ <b>Sent!</b> We've emailed a copy to <b>${userData.email}</b>.`, 'bot');
            addMessage(`Your Reference: <b>${refNum}</b><br>Please quote this when calling us at <b>${contactNum}</b>.`, 'bot');

            // Reset
            setTimeout(() => {
                addMessage(`<button class="action-btn" onclick="startRenovation()">Start Over üîÑ</button>`, 'bot');
                chatState = 'initial';
            }, 4000);

        } catch (e) {
            console.error(e);
            // Even if CORS warns, the data usually hits the webhook.
            addMessage(`‚úÖ <b>Sent!</b> (Ref: ${refNum})`, 'bot');
        }
      }

    </script>
</body>
</html>